<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>è¨ºæ–·ç‰ˆï¼šSpeechRecognition + é€å­—ã€Œå®¶åº­ã€</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--ink:#111827;--muted:#6b7280;--ok:#16a34a;--err:#dc2626;--accent:#2563eb}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang HK,"Microsoft JhengHei",sans-serif;display:flex;justify-content:center;align-items:center}
  .wrap{width:min(960px,96vw);background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:18px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .pill{display:inline-block;background:#eef2ff;color:#3043a9;border-radius:999px;padding:3px 10px;font-size:12px}
  .warn{color:#b45309;font-size:12px}
  .han{font-size:120px;line-height:1;text-align:center;margin:10px 0}
  button,select{font:inherit}
  button{border:0;border-radius:12px;padding:10px 16px;cursor:pointer;background:var(--accent);color:#fff}
  button.ghost{background:#eef2ff;color:#3043a9}
  button:disabled{opacity:.5;cursor:not-allowed}
  .status{text-align:center;margin-top:6px;font-size:18px}
  .ok{color:var(--ok);font-weight:700}
  .err{color:var(--err);font-weight:700}
  .list{text-align:center;font-size:14px;color:var(--muted)}
  pre{background:#0b1020;color:#e6edf3;padding:10px;border-radius:10px;white-space:pre-wrap;word-break:break-word;max-height:240px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <div><b>è¨ºæ–·ç‰ˆ Â· Web Speech + é€å­—æœ—è®€</b></div>
    <div class="row" style="gap:8px">
      <span id="ctxBadge" class="pill">ç’°å¢ƒï¼šæª¢æŸ¥ä¸­â€¦</span>
      <span id="srBadge" class="pill">SRï¼šæª¢æŸ¥ä¸­â€¦</span>
      <span id="langBadge" class="pill">èªè¨€ï¼šyue-HK</span>
    </div>
  </div>

  <div class="row" style="margin-top:6px">
    <div class="warn" id="ctxWarn" style="display:none">âš  å»ºè­°ä½¿ç”¨ HTTPS æˆ– localhostï¼Œå¦å‰‡éŒ„éŸ³æ¬Šé™å¯èƒ½ä¸ç©©å®šã€‚</div>
    <div class="row" style="gap:8px">
      <label for="langSel" style="font-size:12px;color:#6b7280">è­˜åˆ¥èªè¨€ï¼š</label>
      <select id="langSel">
        <option value="yue-HK" selected>yue-HKï¼ˆç²µèªï¼‰</option>
        <option value="zh-HK">zh-HKï¼ˆä¸­æ–‡Â·é¦™æ¸¯ï¼‰</option>
      </select>
      <button class="ghost" id="micTestBtn" type="button">ğŸ¤ æ¸¬è©¦éº¥å…‹é¢¨</button>
      <button class="ghost" id="ttsBtn" type="button">ğŸ”Š ç²µèªç¤ºç¯„</button>
    </div>
  </div>

  <div class="han" id="han">å®¶</div>

  <div class="row" style="justify-content:center;gap:10px">
    <button id="recBtn" type="button">ğŸ™ï¸ é–‹å§‹è®€</button>
    <button id="stopBtn" class="ghost" type="button" disabled>â–  åœæ­¢</button>
  </div>

  <div id="status" class="status">è«‹è®€ï¼šå®¶ â†’ ç„¶å¾Œæ˜¯ï¼šåº­</div>
  <div id="queue" class="list">å‰©é¤˜ï¼šå®¶ã€€åº­</div>

  <h4 style="margin-bottom:6px">äº‹ä»¶æ—¥èªŒ</h4>
  <pre id="log"></pre>

  <h4 style="margin-bottom:6px">æœ€æ–°çµæœ / å€™é¸</h4>
  <pre id="alts"></pre>
</div>

<script>
/* ---------- ç’°å¢ƒæª¢æŸ¥ ---------- */
const ctxBadge = document.getElementById('ctxBadge');
const srBadge  = document.getElementById('srBadge');
const langBadge= document.getElementById('langBadge');
const ctxWarn  = document.getElementById('ctxWarn');

(function(){
  const secure = location.protocol === 'https:' || ['localhost','127.0.0.1'].includes(location.hostname);
  ctxBadge.textContent = 'ç’°å¢ƒï¼š' + (secure ? 'OKï¼ˆå®‰å…¨ï¼‰' : location.protocol + ' @ ' + location.hostname);
  ctxWarn.style.display = secure ? 'none' : 'block';

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  srBadge.textContent = 'SRï¼š' + (SR ? 'æ”¯æ´' : 'ä¸æ”¯æ´');
})();

/* ---------- è¨“ç·´è³‡æ–™ï¼šé€å­—éšŠåˆ—ã€Œå®¶åº­ã€ ---------- */
const WORDS = [
  {
    han:"å®¶",
    okHan:new Set(["å®¶","åŠ ","æ¶","åƒ¹","å˜‰","å’–","ä¼½","è¿¦","çˆ","å˜","å™¶","å—„","å‚¢","æ ¼"]),
    okJyut:["gaa","gaa1","gaa3","ga","gaak","gaak3"]
  },
  {
    han:"åº­",
    okHan:new Set(["åº­","åœ","å»·","äº­","éœ†","èœ“","è‰‡","æŒº","è›"]),
    okJyut:["ting","ting4","ting2","ting1","teen","teng","ten","tin","dien","din"]
  }
];
let queue = [0,1];
let current = 0;

/* ---------- UI å…ƒä»¶ ---------- */
const hanEl   = document.getElementById('han');
const queueEl = document.getElementById('queue');
const statusEl= document.getElementById('status');
const logEl   = document.getElementById('log');
const altsEl  = document.getElementById('alts');
const recBtn  = document.getElementById('recBtn');
const stopBtn = document.getElementById('stopBtn');
const micTestBtn = document.getElementById('micTestBtn');
const ttsBtn  = document.getElementById('ttsBtn');
const langSel = document.getElementById('langSel');

function updateUI(){
  hanEl.textContent = WORDS[current].han;
  queueEl.textContent = "å‰©é¤˜ï¼š" + queue.map(i=>WORDS[i].han).join("ã€€");
  statusEl.textContent = "è«‹è®€ï¼š" + WORDS[current].han + (queue.length>1 ? " â†’ ç„¶å¾Œï¼š" + WORDS[queue[1]].han : "");
}

/* ---------- TTSï¼ˆç¤ºç¯„ï¼‰ ---------- */
let voices=[], yueVoice=null;
function pickYue(){
  voices = window.speechSynthesis.getVoices();
  const by = v => (v.lang||"").toLowerCase();
  const cands = [
    ...voices.filter(v => by(v).includes("yue") && by(v).includes("hk")),
    ...voices.filter(v => by(v).includes("zh") && by(v).includes("hk")),
    ...voices.filter(v => /hong\s*kong|cantonese|ç²µ|ç²¤/.test((v.name||"")+" "+(v.lang||"")))
  ];
  yueVoice = cands[0] || null;
}
if ("speechSynthesis" in window){
  window.speechSynthesis.onvoiceschanged = pickYue;
  setTimeout(pickYue, 200);
}
ttsBtn.addEventListener('click', ()=>{
  const u=new SpeechSynthesisUtterance(WORDS[current].han);
  if (yueVoice){ u.voice=yueVoice; u.lang=yueVoice.lang || "yue-HK"; }
  else u.lang="yue-HK";
  speechSynthesis.cancel(); speechSynthesis.speak(u);
});

/* ---------- éº¥å…‹é¢¨æ¸¬è©¦ï¼ˆå¯çœ‹åˆ°æ˜¯å¦å–åˆ°éŸ³æºï¼‰ ---------- */
micTestBtn.addEventListener('click', async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    log('getUserMedia âœ… å·²å–å¾—éŸ³æº');
    stream.getTracks().forEach(t=>t.stop());
  }catch(err){
    log('getUserMedia âŒ å¤±æ•—ï¼š'+err.name+' - '+err.message);
  }
});

/* ---------- SpeechRecognition ---------- */
let recognizing=false, recognition=null, watchdog=null;

function initSR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR){
    log('SR ä¸æ”¯æ´ï¼šwindow.SpeechRecognition / webkitSpeechRecognition ä¸å­˜åœ¨');
    recBtn.disabled=true; stopBtn.disabled=true;
    return;
  }
  recognition = new SR();
  // å˜—è©¦ç”¨ä¸‹æ‹‰èªè¨€ï¼›å¦‚è¨­ç½®å‡ºéŒ¯ â†’ é€€å› zh-HK
  const want = langSel.value || "yue-HK";
  try { recognition.lang = want; }
  catch(e){ recognition.lang = "zh-HK"; log('è¨­ç½®èªè¨€å¤±æ•—ï¼Œé€€å› zh-HKï¼š'+e.message); }
  langBadge.textContent = "èªè¨€ï¼š"+recognition.lang;

  recognition.interimResults = false;
  recognition.continuous = false;
  recognition.maxAlternatives = 5;

  recognition.onaudiostart = ()=>log('[onaudiostart] æœ‰éŸ³é »è¼¸å…¥');
  recognition.onsoundstart = ()=>log('[onsoundstart] æª¢æ¸¬åˆ°è²éŸ³');
  recognition.onsoundend   = ()=>log('[onsoundend] è²éŸ³çµæŸ');
  recognition.onaudioend   = ()=>log('[onaudioend] éŸ³é »çµæŸ');

  recognition.onstart = ()=>{
    recognizing = true;
    recBtn.disabled = true; stopBtn.disabled = false;
    log('[onstart] é–‹å§‹è¾¨è­˜');
    statusEl.textContent = "ğŸ¤ æ­£åœ¨è½â€¦è«‹è®€ï¼šã€Œ"+WORDS[current].han+"ã€";
    altsEl.textContent = '';
    clearTimeout(watchdog);
    watchdog = setTimeout(()=>{
      safeStop();
      statusEl.textContent = "â± 6ç§’å…§æœªæ”¶åˆ°çµæœï¼Œè«‹å†è©¦ã€‚";
      statusEl.className = "status err";
      log('[watchdog] è¶…æ™‚è‡ªå‹•åœæ­¢');
    }, 6000);
  };

  recognition.onspeechend = ()=>{ log('[onspeechend] èªéŸ³åœæ­¢ â†’ stop()'); safeStop(); };
  recognition.onnomatch  = (e)=>{ log('[onnomatch] æ²’æœ‰åŒ¹é…ï¼š'+JSON.stringify(e)); };

  recognition.onerror = (e)=>{
    recognizing=false; recBtn.disabled=false; stopBtn.disabled=true;
    clearTimeout(watchdog);
    statusEl.textContent = "è­˜åˆ¥éŒ¯èª¤ï¼š"+(e.error||'unknown');
    statusEl.className = "status err";
    log('[onerror] '+(e.error||'unknown'));
  };

  recognition.onend = ()=>{
    recognizing=false; recBtn.disabled=false; stopBtn.disabled=true;
    clearTimeout(watchdog);
    log('[onend] çµæŸè¾¨è­˜');
  };

  recognition.onresult = (e)=>{
    clearTimeout(watchdog);
    const hyps=[], lines=[];
    for (let i=0;i<e.results.length;i++){
      const best = e.results[i][0];
      if (best){
        hyps.push(best.transcript.trim());
        lines.push(`#${i+1} ã€Œ${best.transcript.trim()}ã€ (conf=${(best.confidence||0).toFixed(2)})`);
      }
    }
    altsEl.textContent = lines.join('\n') || '(ç„¡)';
    log('[onresult] æ”¶åˆ°çµæœï¼š'+hyps.join(' | '));
    judge(hyps);
  };
}
function safeStop(){ try{ recognition && recognition.stop && recognition.stop(); }catch{} }

function log(msg){ const t=new Date().toLocaleTimeString(); logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent; }

function norm(s){
  return (s||"").toLowerCase()
   .replace(/[ï¼Œã€‚ï¼ï¼Ÿã€,.!?\s]/g,"")
   .replace(/å””|å•Š|å‘€|å‘¢|å–|å•¦|å–‡|å›‰|å˜…|å€‹/g,"");
}

function judge(hyps){
  if (!hyps || !hyps.length){
    statusEl.textContent = "æœªæ”¶åˆ°çµæœï¼Œè«‹å†è©¦ã€‚";
    statusEl.className = "status err";
    return;
  }
  const w = WORDS[current];
  const passed = hyps.some(txt=>{
    const s = norm(txt);
    // A) åŒ…å«å®¹è¨±ä¸­æ–‡å­—
    for (const ch of w.okHan){ if (s.includes(ch)) return true; }
    // B) åŒ…å«å®¹è¨±ç¾…é¦¬æ‹¼
    if (w.okJyut.some(j => s.includes(j))) return true;
    // C) æ¥µç°¡å®¹éŒ¯ï¼ˆæ¯éŸ³æ¥è¿‘ï¼‰
    if (w.han === "å®¶" && /^g(a|aa)/.test(s)) return true;
    if (w.han === "åº­" && /^t(i|e)/.test(s)) return true;
    return false;
  });

  if (passed){
    statusEl.textContent = "âœ… è®€å°ï¼šã€Œ"+w.han+"ã€";
    statusEl.className = "status ok";
    queue.shift();
    if (queue.length === 0){
      hanEl.textContent = "ğŸ‰ å®Œæˆï¼";
      queueEl.textContent = "å…¨éƒ¨è®€å°ï¼";
      recBtn.disabled = true; stopBtn.disabled = true;
      return;
    }
    current = queue[0];
    updateUI();
  }else{
    statusEl.textContent = "âŒ æœªä¼¼å‘€ï¼Œç¨å¾Œæœƒå†å‡ºåŒä¸€å­—ã€‚";
    statusEl.className = "status err";
    queue.push(queue.shift());
    current = queue[0];
    setTimeout(updateUI, 700);
  }
}

/* äº‹ä»¶ç¶å®šèˆ‡åˆå§‹åŒ– */
langSel.addEventListener('change', ()=>{
  try{ recognition && recognition.abort && recognition.abort(); }catch{}
  initSR(); updateUI();
});
recBtn.addEventListener('click', ()=>{ altsEl.textContent=''; log('å‘¼å« start()'); try{ recognition.start(); }catch(err){ log('start() å¤±æ•—ï¼š'+err.message); } });
stopBtn.addEventListener('click', ()=>{ log('æ‰‹å‹• stop()'); safeStop(); });

initSR();
updateUI();
</script>
</body>
</html>
